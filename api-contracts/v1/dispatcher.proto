syntax = "proto3";

option go_package = "github.com/hatchet-dev/hatchet/internal/services/shared/proto/v1";

package v1;

import "v1/shared/condition.proto";

service V1Dispatcher {
    rpc DurableTask(stream DurableTaskRequest) returns (stream DurableTaskResponse) {}

    // NOTE: deprecated after DurableEventLog is implemented
    rpc RegisterDurableEvent(RegisterDurableEventRequest) returns (RegisterDurableEventResponse) {}
    rpc ListenForDurableEvent(stream ListenForDurableEventRequest) returns (stream DurableEvent) {}
}

message DurableTaskRequestRegisterWorker {
    string worker_id = 1;
}

message DurableTaskResponseRegisterWorker {
    string worker_id = 1;
}

enum DurableTaskTriggerKind {
    DURABLE_TASK_TRIGGER_KIND_UNSPECIFIED = 0;
    DURABLE_TASK_TRIGGER_KIND_RUN = 1;
    DURABLE_TASK_TRIGGER_KIND_WAIT_FOR = 2;
    DURABLE_TASK_TRIGGER_KIND_MEMO = 3;
}

message DurableTaskRequestTrigger {
    // The session_id is used to identify the worker session for this durable task, since
    // there can be many sessions for the same durable task (e.g. retries)
    int64 session_id = 1;
    string durable_task_external_id = 2;
    DurableTaskTriggerKind kind = 3;
    optional bytes payload = 4;
    optional DurableEventListenerConditions wait_for_conditions = 5;
}

message DurableTaskResponseTriggerAck {
    int64 session_id = 1;
    string durable_task_external_id = 2;
    int64 node_id = 3;
}

message DurableTaskRequestRegisterCallback {
    int64 session_id = 1;
    string durable_task_external_id = 2;
    int64 node_id = 3;
}

message DurableTaskResponseRegisterCallbackAck {
    int64 session_id = 1;
    string durable_task_external_id = 2;
    int64 node_id = 3;
}

message DurableTaskResponseCallbackCompleted {
    int64 session_id = 1;
    string durable_task_external_id = 2;
    int64 node_id = 3;
    bytes payload = 4;
}

message DurableTaskRequestEvictSession {
    int64 session_id = 1;
    string durable_task_external_id = 2;
}

message DurableTaskRequest {
    oneof message {
        DurableTaskRequestRegisterWorker register_worker = 1;
        DurableTaskRequestTrigger trigger = 2;
        DurableTaskRequestRegisterCallback register_callback = 3;
        DurableTaskRequestEvictSession evict_session = 4;
    }
}

message DurableTaskResponse {
    oneof message {
        DurableTaskResponseRegisterWorker register_worker = 1;
        DurableTaskResponseTriggerAck trigger_ack = 2;
        DurableTaskResponseRegisterCallbackAck register_callback_ack = 3;
        DurableTaskResponseCallbackCompleted callback_completed = 4;
    }
}

message RegisterDurableEventRequest {
    string task_id = 1; // external uuid for the task run
    string signal_key = 2; // the signal key for the event
    DurableEventListenerConditions conditions = 3; // the task conditions for creating the task
}

message RegisterDurableEventResponse {
}

message ListenForDurableEventRequest {
    string task_id = 1; // single listener per worker
    string signal_key = 2; // the match id for the listener
}

message DurableEvent {
    string task_id = 1;
    string signal_key = 2;
    bytes data = 3; // the data for the event
}
